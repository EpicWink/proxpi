name: publish-docker

on:
  push:
    branches:
      - docker-test

jobs:
  release:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        platform: ['linux/amd64', 'linux/arm64', 'linux/arm/v7']
    steps:
    - uses: actions/checkout@v3
    - name: Build image
      run: docker buildx build .
        --platform "${{ matrix.platform }}"
        --tag "epicwink/proxpi:${{ github.ref_name }}"
    - name: Run unit-tests in image
      run: docker run
        --rm
        --volume "$(pwd)/tests:/srv/tests"
        --entrypoint ''
        "epicwink/proxpi:${{ github.ref_name }}"
        sh -c 'pip install --requirement /srv/tests/requirements.txt
        && pytest -vvra /srv/tests'
    - name: Run image test
      run: tests/test-docker-image.sh "${{ github.ref_name }}"
